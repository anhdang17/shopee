<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giỏ hàng | Shopee Clone</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
    <link rel="stylesheet" href="./assets/css/base.css">
    <link rel="stylesheet" href="./assets/css/grid.css">
    <link rel="stylesheet" href="./assets/css/style.css">
    <link rel="stylesheet" href="./assets/css/responsive.css">
    <link rel="stylesheet" href="./assets/css/auth.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <header class="cart-header">
        <div class="grid wide">
            <div class="cart-header__content">
                <a href="./index.html" class="cart-header__logo">
                    <img src="./assets/img/logo/shopee-logo.png" alt="Shopee logo">
                </a>
                <h1 class="cart-header__title">Giỏ hàng của tôi</h1>
            </div>
        </div>
    </header>

    <main class="cart-main">
        <div class="grid wide">
            <div class="cart-container">
                <div class="cart-content">
                    <div class="cart-bulk-actions">
                        <label class="cart-bulk-select">
                            <input type="checkbox" id="toggleAllCart"> Chọn tất cả
                        </label>
                        <button class="cart-bulk-clear" id="clearCartBtn" type="button">Xóa toàn bộ</button>
                    </div>
                    <div class="cart-items" id="cartItems">
                        <!-- Items rendered by JavaScript -->
                    </div>

                    <div class="cart-empty" id="cartEmpty" style="display: none;">
                        <img src="./assets/img/sp/no-cart.png" alt="Empty cart" class="cart-empty-img">
                        <p class="cart-empty-text">Giỏ hàng của bạn trống</p>
                        <a href="./index.html" class="btn btn--primary">Mua ngay</a>
                    </div>
                </div>

                <div class="cart-summary">
                    <div class="checkout-section">
                        <h3>Thông tin giao hàng</h3>
                        <form id="shippingForm" novalidate>
                            <div class="checkout-field">
                                <label for="checkout-recipient">Tên người nhận</label>
                                <input type="text" id="checkout-recipient" name="recipientName" placeholder="Nguyễn Văn A">
                            </div>
                            <div class="checkout-field">
                                <label for="checkout-phone">Số điện thoại</label>
                                <input type="tel" id="checkout-phone" name="recipientPhone" placeholder="0987 654 321">
                            </div>
                            <div class="checkout-field">
                                <label for="checkout-address">Địa chỉ cụ thể</label>
                                <input type="text" id="checkout-address" name="addressLine" placeholder="123 Trần Hưng Đạo, Quận 1">
                            </div>
                            <div class="checkout-field">
                                <label for="checkout-city">Tỉnh / Thành phố</label>
                                <input type="text" id="checkout-city" name="city" placeholder="Hồ Chí Minh">
                            </div>
                            <div class="checkout-field">
                                <label for="checkout-note">Ghi chú cho shipper</label>
                                <input type="text" id="checkout-note" name="note" placeholder="Gọi trước khi giao">
                            </div>
                        </form>
                    </div>

                    <div class="checkout-section">
                        <h3>Phương thức vận chuyển</h3>
                        <label class="checkout-radio">
                            <input type="radio" name="shippingMethod" value="standard" data-fee="0" checked> Tiêu chuẩn (3-5 ngày) - Miễn phí
                        </label>
                        <label class="checkout-radio">
                            <input type="radio" name="shippingMethod" value="fast" data-fee="15000"> Nhanh (2-3 ngày) - 15.000đ
                        </label>
                        <label class="checkout-radio">
                            <input type="radio" name="shippingMethod" value="express" data-fee="30000"> Hỏa tốc (24h) - 30.000đ
                        </label>
                    </div>

                    <div class="checkout-section">
                        <h3>Thanh toán</h3>
                        <label class="checkout-radio">
                            <input type="radio" name="paymentMethod" value="cod" checked> Thanh toán khi nhận hàng (COD)
                        </label>
                        <label class="checkout-radio">
                            <input type="radio" name="paymentMethod" value="card"> Thẻ ngân hàng / Visa / MasterCard
                        </label>
                        <div class="payment-card-fields" id="cardFields">
                            <div class="checkout-field">
                                <label for="card-name">Tên in trên thẻ</label>
                                <input type="text" id="card-name" placeholder="NGUYEN VAN A">
                            </div>
                            <div class="checkout-field">
                                <label for="card-number">Số thẻ</label>
                                <input type="text" id="card-number" placeholder="1234 5678 9012 3456" maxlength="19">
                            </div>
                            <div class="checkout-field">
                                <label for="card-expiry">Ngày hết hạn (MM/YY)</label>
                                <input type="text" id="card-expiry" placeholder="08/28" maxlength="5">
                            </div>
                            <div class="checkout-field">
                                <label for="card-cvv">CVV</label>
                                <input type="password" id="card-cvv" placeholder="***" maxlength="4">
                            </div>
                        </div>
                    </div>

                    <div class="cart-summary-header">
                        <h3>Tóm tắt đơn hàng</h3>
                    </div>
                    <div class="cart-summary-content">
                        <div class="cart-summary-row">
                            <span>Sản phẩm đã chọn</span>
                            <span id="cartSelectionCount">0</span>
                        </div>
                        <div class="cart-summary-row">
                            <span>Tạm tính</span>
                            <span id="cartSubtotal">0đ</span>
                        </div>
                        <div class="cart-summary-row">
                            <span>Phí vận chuyển</span>
                            <span id="cartShippingFee">0đ</span>
                        </div>
                        <div class="cart-summary-row">
                            <span>Thanh toán</span>
                            <span id="cartPaymentLabel">COD</span>
                        </div>
                        <div class="cart-summary-divider"></div>
                        <div class="cart-summary-row cart-summary-total">
                            <span>Tổng cộng</span>
                            <span id="cartTotal">0đ</span>
                        </div>
                    </div>
                    <div class="profile-alert" id="checkoutMessage"></div>
                    <button class="btn btn--primary cart-checkout-btn" id="checkoutBtn">Đặt hàng</button>
                </div>
            </div>
        </div>
    </main>

    <style>
        .cart-header {
            background: linear-gradient(var(--main-color1), var(--main-color2));
            padding: 16px 0;
        }

        .cart-header__content {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .cart-header__logo img {
            width: 120px;
            height: auto;
        }

        .cart-header__title {
            color: var(--white-color);
            font-size: 2rem;
            margin: 0;
        }

        .cart-main {
            background: #f5f5f5;
            min-height: calc(100vh - 80px);
            padding: 32px 0;
        }

        .cart-container {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 24px;
        }

        .cart-content {
            background: #fff;
            border-radius: 8px;
            padding: 24px;
        }

        .cart-items {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .cart-bulk-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            gap: 12px;
        }

        .cart-bulk-select {
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .cart-bulk-clear {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 1.4rem;
        }

        .cart-item {
            display: flex;
            gap: 16px;
            padding: 16px;
            border: 1px solid #eee;
            border-radius: 8px;
            align-items: flex-start;
        }

        .cart-item-checkbox {
            width: 20px;
            height: 20px;
            margin-top: 8px;
        }

        .cart-item-img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border: 1px solid #eee;
            border-radius: 4px;
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-name {
            font-size: 1.4rem;
            color: var(--text-color);
            margin: 0 0 8px;
        }

        .cart-item-seller {
            font-size: 1.2rem;
            color: #888;
            margin: 0 0 12px;
        }

        .cart-item-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .cart-item-btn-remove,
        .cart-item-btn-save {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.3rem;
            cursor: pointer;
            padding: 0;
        }

        .cart-item-btn-remove:hover,
        .cart-item-btn-save:hover {
            color: var(--primary-color);
        }

        .cart-item-separator {
            color: #ddd;
        }

        .cart-item-price-section {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 16px;
        }

        .cart-item-note {
            font-size: 1.2rem;
            color: #888;
        }

        .cart-item-price {
            font-size: 1.6rem;
            color: var(--primary-color);
            font-weight: 600;
        }

        .cart-item-quantity {
            display: flex;
            align-items: center;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .cart-qty-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: #fff;
            cursor: pointer;
            font-size: 1.6rem;
        }

        .cart-qty-btn:hover {
            background: #f5f5f5;
        }

        .cart-qty-input {
            width: 50px;
            height: 32px;
            border: none;
            border-left: 1px solid #ddd;
            border-right: 1px solid #ddd;
            text-align: center;
            font-size: 1.4rem;
        }

        .cart-empty {
            text-align: center;
            padding: 64px 24px;
        }

        .cart-empty-img {
            width: 200px;
            margin-bottom: 24px;
        }

        .cart-empty-text {
            font-size: 1.6rem;
            color: var(--text-color);
            margin-bottom: 24px;
        }

        .cart-summary {
            background: #fff;
            border-radius: 8px;
            padding: 24px;
            height: fit-content;
            position: sticky;
            top: 24px;
        }

        .checkout-section {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .checkout-section h3 {
            margin: 0 0 12px;
            font-size: 1.6rem;
        }

        .checkout-field {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 12px;
        }

        .checkout-field label {
            font-size: 1.3rem;
            color: #666;
        }

        .checkout-field input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1.4rem;
        }

        .checkout-radio {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 1.3rem;
        }

        .payment-card-fields {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .payment-card-fields.payment-card-fields--show {
            display: grid;
        }

        .cart-summary-header h3 {
            font-size: 1.8rem;
            margin: 0 0 16px;
            color: var(--text-color);
        }

        .cart-summary-content {
            margin-bottom: 24px;
        }

        .cart-summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 1.4rem;
        }

        .cart-summary-total {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .cart-summary-divider {
            height: 1px;
            background: #eee;
            margin: 16px 0;
        }

        .cart-checkout-btn {
            width: 100%;
            padding: 16px;
            font-size: 1.6rem;
        }

        @media (max-width: 768px) {
            .cart-container {
                grid-template-columns: 1fr;
            }

            .cart-summary {
                position: static;
            }
        }
    </style>

    <script src="./assets/js/app.js"></script>
    <script>
        const cartItemsEl = document.getElementById('cartItems');
        const cartEmptyEl = document.getElementById('cartEmpty');
        const subtotalEl = document.getElementById('cartSubtotal');
        const totalEl = document.getElementById('cartTotal');
        const selectionCountEl = document.getElementById('cartSelectionCount');
        const toggleAllCheckbox = document.getElementById('toggleAllCart');
        const clearCartBtn = document.getElementById('clearCartBtn');
        const checkoutBtn = document.getElementById('checkoutBtn');
        const shippingForm = document.getElementById('shippingForm');
        const shippingMethodInputs = document.querySelectorAll('input[name="shippingMethod"]');
        const paymentMethodInputs = document.querySelectorAll('input[name="paymentMethod"]');
        const cardFieldsWrapper = document.getElementById('cardFields');
        const cardNameInput = document.getElementById('card-name');
        const cardNumberInput = document.getElementById('card-number');
        const cardExpiryInput = document.getElementById('card-expiry');
        const cardCvvInput = document.getElementById('card-cvv');
        const shippingFeeEl = document.getElementById('cartShippingFee');
        const paymentLabelEl = document.getElementById('cartPaymentLabel');
        const checkoutMessage = document.getElementById('checkoutMessage');
        const shippingFees = {
            standard: 0,
            fast: 15000,
            express: 30000
        };
        let selectedIds = new Set();
        let currentShippingMethod = 'standard';
        let currentShippingFee = 0;
        let currentPaymentMethod = 'cod';

        function formatPrice(value) {
            return ShopeeApp.formatCurrency(value);
        }

        function getCartSnapshot() {
            return ShopeeApp.getCart();
        }

        function syncSelection(items) {
            if (!selectedIds.size) {
                selectedIds = new Set(items.map(item => item.id));
                return;
            }
            const next = new Set(items.filter(item => selectedIds.has(item.id)).map(item => item.id));
            if (!next.size) {
                selectedIds = new Set(items.map(item => item.id));
            } else {
                selectedIds = next;
            }
        }

        function renderCartItem(item) {
            const stock = ShopeeApp.getAvailableStock(item.id);
            const maxQuantity = stock > 0 ? stock : 1;
            const constrainedQuantity = Math.min(item.quantity, maxQuantity);
            if (constrainedQuantity !== item.quantity) {
                ShopeeApp.updateCartQuantity(item.id, constrainedQuantity);
            }
            const sku = ShopeeApp.getInventory()[item.id]?.sku || `SP${item.id.padStart ? item.id.padStart(3, '0') : item.id}`;
            const checked = selectedIds.has(item.id) ? 'checked' : '';
            return `
                <div class="cart-item" data-id="${item.id}">
                    <input type="checkbox" class="cart-item-checkbox" data-id="${item.id}" ${checked}>
                    <img src="${item.image}" alt="${item.name}" class="cart-item-img">
                    <div class="cart-item-info">
                        <h3 class="cart-item-name">${item.name}</h3>
                        <p class="cart-item-seller">SKU: ${sku}</p>
                        <div class="cart-item-actions">
                            <button class="cart-item-btn-remove" data-action="remove" data-id="${item.id}">Xóa</button>
                            <span class="cart-item-separator">|</span>
                            <button class="cart-item-btn-save" data-action="save" data-id="${item.id}">Lưu để sau</button>
                        </div>
                    </div>
                    <div class="cart-item-price-section">
                        <div class="cart-item-price">${formatPrice(item.price)}</div>
                        <div class="cart-item-quantity" data-id="${item.id}">
                            <button class="cart-qty-btn" data-action="decrease" data-id="${item.id}">-</button>
                            <input type="number" class="cart-qty-input" data-id="${item.id}" value="${constrainedQuantity}" min="1" max="${maxQuantity}">
                            <button class="cart-qty-btn" data-action="increase" data-id="${item.id}">+</button>
                        </div>
                        <span class="cart-item-note">Tối đa ${stock} sản phẩm</span>
                    </div>
                </div>
            `;
        }

        function renderCart() {
            const items = getCartSnapshot();
            if (!items.length) {
                cartItemsEl.innerHTML = '';
                cartItemsEl.style.display = 'none';
                cartEmptyEl.style.display = 'block';
                toggleAllCheckbox.checked = false;
                selectedIds.clear();
                updateTotals();
                return;
            }

            syncSelection(items);
            const html = items.map(renderCartItem).join('');
            cartItemsEl.innerHTML = html;
            cartItemsEl.style.display = 'flex';
            cartEmptyEl.style.display = 'none';
            toggleAllCheckbox.checked = selectedIds.size === items.length;
            updateTotals();
        }

        function setCheckoutMessage(text = '', type = 'info') {
            if (!checkoutMessage) return;
            if (!text) {
                checkoutMessage.textContent = '';
                checkoutMessage.className = 'profile-alert';
                return;
            }
            checkoutMessage.textContent = text;
            checkoutMessage.className = `profile-alert profile-alert--show auth-alert auth-alert--${type}`;
        }

        function updateTotals() {
            const items = getCartSnapshot();
            const selectedItems = items.filter(item => selectedIds.has(item.id));
            const subtotal = selectedItems.reduce((sum, item) => sum + item.price * item.quantity, 0);
            const shippingFee = selectedItems.length ? currentShippingFee : 0;
            const total = subtotal + shippingFee;
            selectionCountEl.textContent = selectedItems.length.toString();
            subtotalEl.textContent = formatPrice(subtotal);
            shippingFeeEl.textContent = formatPrice(shippingFee);
            totalEl.textContent = formatPrice(total);
            paymentLabelEl.textContent = currentPaymentMethod === 'card' ? 'Thẻ ngân hàng' : 'COD';
        }

        function handleQuantityChange(productId, nextQuantity) {
            if (nextQuantity <= 0) {
                ShopeeApp.removeCartItem(productId);
                selectedIds.delete(productId);
                ShopeeApp.toast('Đã xóa sản phẩm khỏi giỏ hàng', 'success');
                renderCart();
                return;
            }
            const result = ShopeeApp.updateCartQuantity(productId, nextQuantity);
            if (!result.ok && result.reason) {
                ShopeeApp.toast(result.reason, 'error');
            } else {
                ShopeeApp.toast('Đã cập nhật số lượng', 'success');
            }
            renderCart();
        }

        cartItemsEl.addEventListener('click', (event) => {
            const target = event.target;
            if (target.matches('.cart-qty-btn')) {
                const productId = target.dataset.id;
                const action = target.dataset.action;
                const items = getCartSnapshot();
                const current = items.find(item => item.id === productId);
                if (!current) return;
                const delta = action === 'increase' ? 1 : -1;
                handleQuantityChange(productId, current.quantity + delta);
            }

            if (target.matches('[data-action="remove"]')) {
                const productId = target.dataset.id;
                ShopeeApp.removeCartItem(productId);
                selectedIds.delete(productId);
                ShopeeApp.toast('Đã xóa sản phẩm', 'success');
                renderCart();
            }

            if (target.matches('[data-action="save"]')) {
                ShopeeApp.toast('Chức năng lưu sản phẩm đang được phát triển', 'info');
            }
        });

        cartItemsEl.addEventListener('change', (event) => {
            const target = event.target;
            if (target.matches('.cart-item-checkbox')) {
                const id = target.dataset.id;
                if (target.checked) {
                    selectedIds.add(id);
                } else {
                    selectedIds.delete(id);
                }
                toggleAllCheckbox.checked = selectedIds.size === getCartSnapshot().length;
                updateTotals();
            }

            if (target.matches('.cart-qty-input')) {
                const id = target.dataset.id;
                const value = parseInt(target.value, 10);
                if (Number.isNaN(value)) {
                    target.value = '1';
                    return;
                }
                handleQuantityChange(id, value);
            }
        });

        toggleAllCheckbox.addEventListener('change', () => {
            const items = getCartSnapshot();
            if (toggleAllCheckbox.checked) {
                selectedIds = new Set(items.map(item => item.id));
            } else {
                selectedIds.clear();
            }
            renderCart();
        });

        clearCartBtn.addEventListener('click', () => {
            if (!getCartSnapshot().length) {
                return;
            }
            if (confirm('Bạn có chắc muốn xóa tất cả sản phẩm trong giỏ?')) {
                ShopeeApp.clearCart();
                selectedIds.clear();
                renderCart();
                ShopeeApp.toast('Đã làm trống giỏ hàng', 'success');
            }
        });

        function populateCheckoutForm() {
            if (!shippingForm) return;
            const storedUser = sessionStorage.getItem('shopeeUser');
            const user = storedUser ? JSON.parse(storedUser) : {};
            const checkoutProfile = ShopeeApp.getCheckoutProfile();
            currentShippingMethod = checkoutProfile.shippingMethod || 'standard';
            currentPaymentMethod = checkoutProfile.paymentMethod || 'cod';
            currentShippingFee = shippingFees[currentShippingMethod] || 0;

            if (shippingMethodInputs.length) {
                shippingMethodInputs.forEach(input => {
                    input.checked = input.value === currentShippingMethod;
                });
            }
            if (paymentMethodInputs.length) {
                paymentMethodInputs.forEach(input => {
                    input.checked = input.value === currentPaymentMethod;
                });
            }

            const shippingAddress = checkoutProfile.shippingAddress || {};
            shippingForm.recipientName.value = shippingAddress.recipientName || user.name || '';
            shippingForm.recipientPhone.value = shippingAddress.recipientPhone || user.phone || '';
            shippingForm.addressLine.value = shippingAddress.addressLine || user.address || '';
            shippingForm.city.value = shippingAddress.city || '';
            shippingForm.note.value = shippingAddress.note || '';

            const cardInfo = checkoutProfile.paymentCard || {};
            cardNameInput.value = cardInfo.cardName || '';
            cardNumberInput.value = cardInfo.cardNumber || '';
            cardExpiryInput.value = cardInfo.expiry || '';
            cardCvvInput.value = cardInfo.cvv || '';

            toggleCardFields();
        }

        function toggleCardFields() {
            if (!cardFieldsWrapper) return;
            if (currentPaymentMethod === 'card') {
                cardFieldsWrapper.classList.add('payment-card-fields--show');
            } else {
                cardFieldsWrapper.classList.remove('payment-card-fields--show');
            }
        }

        if (shippingForm) {
            shippingForm.addEventListener('submit', (event) => event.preventDefault());
        }

        shippingMethodInputs.forEach(input => {
            input.addEventListener('change', function() {
                if (!this.checked) return;
                currentShippingMethod = this.value;
                currentShippingFee = shippingFees[currentShippingMethod] || 0;
                updateTotals();
            });
        });

        paymentMethodInputs.forEach(input => {
            input.addEventListener('change', function() {
                if (!this.checked) return;
                currentPaymentMethod = this.value;
                toggleCardFields();
                updateTotals();
            });
        });

        function validateCardInfo(cardNumber, expiry, cvv) {
            const errors = [];
            const number = cardNumber.replace(/\s+/g, '');
            if (!/^\d{12,19}$/.test(number)) {
                errors.push('Số thẻ không hợp lệ');
            }
            if (!/^(0[1-9]|1[0-2])\/\d{2}$/.test(expiry)) {
                errors.push('Ngày hết hạn phải theo định dạng MM/YY');
            }
            if (!/^\d{3,4}$/.test(cvv)) {
                errors.push('CVV không hợp lệ');
            }
            return errors;
        }

        checkoutBtn.addEventListener('click', () => {
            setCheckoutMessage();
            const items = getCartSnapshot();
            const selectedItems = items.filter(item => selectedIds.has(item.id));
            if (!selectedItems.length) {
                setCheckoutMessage('Vui lòng chọn ít nhất một sản phẩm trước khi đặt hàng', 'error');
                return;
            }

            const shippingData = {
                recipientName: shippingForm.recipientName.value.trim(),
                recipientPhone: shippingForm.recipientPhone.value.trim(),
                addressLine: shippingForm.addressLine.value.trim(),
                city: shippingForm.city.value.trim(),
                note: shippingForm.note.value.trim()
            };

            const errors = [];
            if (!shippingData.recipientName) errors.push('Vui lòng nhập tên người nhận');
            if (!ShopeeApp.validators.phone(shippingData.recipientPhone)) errors.push('Số điện thoại người nhận không hợp lệ');
            if (!shippingData.addressLine) errors.push('Địa chỉ giao hàng chưa đầy đủ');
            if (!shippingData.city) errors.push('Vui lòng nhập tỉnh/thành phố');

            let cardPayload = {};
            if (currentPaymentMethod === 'card') {
                if (!cardNameInput.value.trim()) {
                    errors.push('Vui lòng nhập tên in trên thẻ');
                }
                const cardErrors = validateCardInfo(cardNumberInput.value.trim(), cardExpiryInput.value.trim(), cardCvvInput.value.trim());
                if (cardErrors.length) {
                    errors.push(...cardErrors);
                } else {
                    cardPayload = {
                        cardName: cardNameInput.value.trim(),
                        cardNumber: cardNumberInput.value.trim(),
                        expiry: cardExpiryInput.value.trim(),
                        cvv: cardCvvInput.value.trim()
                    };
                }
            }

            if (errors.length) {
                setCheckoutMessage(errors.join(' • '), 'error');
                return;
            }

            const orderSubtotal = selectedItems.reduce((sum, item) => sum + item.price * item.quantity, 0);
            const orderTotal = orderSubtotal + currentShippingFee;

            ShopeeApp.saveCheckoutProfile({
                shippingMethod: currentShippingMethod,
                paymentMethod: currentPaymentMethod,
                shippingAddress: shippingData,
                paymentCard: cardPayload
            });

            ShopeeApp.toast('Đặt hàng thành công!', 'success');
            alert(`Đơn hàng đang được xử lý.\nSố sản phẩm: ${selectedItems.length}\nTổng thanh toán: ${formatPrice(orderTotal)}`);
            ShopeeApp.clearCart();
            selectedIds.clear();
            renderCart();
            setCheckoutMessage('Thông tin đơn hàng đã được lưu!', 'success');
        });

        populateCheckoutForm();
        renderCart();
    </script>
</body>
</html>




