<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quên mật khẩu | Shopee Clone</title>
    <link rel="stylesheet" href="./assets/css/base.css">
    <link rel="stylesheet" href="./assets/css/grid.css">
    <link rel="stylesheet" href="./assets/css/style.css">
    <link rel="stylesheet" href="./assets/css/responsive.css">
    <link rel="stylesheet" href="./assets/css/auth.css">
</head>
<body class="auth-page">
    <div class="auth-container">
        <a href="./index.html" class="auth-logo">
            <img src="./assets/img/logo/shopee-logo.png" alt="Shopee logo">
        </a>
        <div class="auth-card">
            <h1 class="auth-title">Khôi phục mật khẩu</h1>
            <section class="auth-section">
                <h2 class="auth-section-title">Bước 1 · Nhận mã xác thực</h2>
                <div class="auth-alert" id="requestMessage" role="alert" aria-live="polite"></div>
                <form class="auth-form" id="requestTokenForm">
                    <label class="auth-label" for="request-email">Email tài khoản</label>
                    <input type="email" class="auth-input" id="request-email" name="email" placeholder="email@domain.com">
                    <button type="submit" class="btn btn--primary auth-submit">Gửi mã</button>
                </form>
                <p class="auth-help">Vì đây là bản demo nên mã sẽ hiển thị trực tiếp trên màn hình.</p>
            </section>
            <section class="auth-section">
                <h2 class="auth-section-title">Bước 2 · Đặt lại mật khẩu</h2>
                <div class="auth-alert" id="resetMessage" role="alert" aria-live="polite"></div>
                <form class="auth-form" id="resetPasswordForm">
                    <label class="auth-label" for="reset-email">Email tài khoản</label>
                    <input type="email" class="auth-input" id="reset-email" name="email" placeholder="email@domain.com">

                    <label class="auth-label" for="reset-token">Mã xác thực</label>
                    <input type="text" class="auth-input" id="reset-token" name="token" placeholder="Nhập mã gồm 6 ký tự">

                    <label class="auth-label" for="reset-password">Mật khẩu mới</label>
                    <input type="password" class="auth-input" id="reset-password" name="password" placeholder="••••••••">

                    <button type="submit" class="btn btn--primary auth-submit">Đặt lại mật khẩu</button>
                </form>
            </section>
            <div class="auth-switch">
                <a href="./signin.html">← Quay lại đăng nhập</a>
            </div>
        </div>
    </div>

    <script src="./assets/js/app.js"></script>
    <script>
        const requestForm = document.getElementById('requestTokenForm');
        const resetForm = document.getElementById('resetPasswordForm');
        const requestMessage = document.getElementById('requestMessage');
        const resetMessage = document.getElementById('resetMessage');

        function setMessage(el, text, type = 'info') {
            if (!el) return;
            el.textContent = text || '';
            el.className = `auth-alert auth-alert--${type}`;
        }

        function describePassword(password) {
            if (!password || password.length < 8) {
                return 'Mật khẩu phải có ít nhất 8 ký tự';
            }
            if (!/[A-Z]/.test(password) || !/[a-z]/.test(password) || !/\d/.test(password)) {
                return 'Mật khẩu phải bao gồm chữ hoa, chữ thường và số';
            }
            if (!/[^A-Za-z0-9]/.test(password)) {
                return 'Mật khẩu phải có ký tự đặc biệt';
            }
            return '';
        }

        requestForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const email = (new FormData(requestForm).get('email') || '').trim();
            if (!ShopeeApp.validators.email(email)) {
                setMessage(requestMessage, 'Email không hợp lệ', 'error');
                return;
            }

            const user = ShopeeApp.findUser(email);
            if (!user) {
                setMessage(requestMessage, 'Email chưa được đăng ký', 'error');
                return;
            }

            const token = ShopeeApp.issueForgotToken(email);
            setMessage(requestMessage, `Mã xác thực của bạn là ${token}. Vui lòng nhập trong 10 phút.`, 'success');
        });

        resetForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const data = new FormData(resetForm);
            const email = (data.get('email') || '').trim();
            const token = (data.get('token') || '').trim();
            const password = data.get('password') || '';

            if (!ShopeeApp.validators.email(email)) {
                setMessage(resetMessage, 'Email không hợp lệ', 'error');
                return;
            }

            const user = ShopeeApp.findUser(email);
            if (!user) {
                setMessage(resetMessage, 'Không tìm thấy tài khoản', 'error');
                return;
            }

            if (!token) {
                setMessage(resetMessage, 'Vui lòng nhập mã xác thực', 'error');
                return;
            }

            if (!ShopeeApp.validateForgotToken(email, token)) {
                setMessage(resetMessage, 'Mã xác thực không hợp lệ hoặc đã hết hạn', 'error');
                return;
            }

            const passwordError = describePassword(password);
            if (passwordError) {
                setMessage(resetMessage, passwordError, 'error');
                return;
            }

            const updatedUser = { ...user, password };
            ShopeeApp.upsertUser(updatedUser);
            ShopeeApp.clearForgotToken(email);
            setMessage(resetMessage, 'Đổi mật khẩu thành công! Bạn có thể đăng nhập lại.', 'success');
        });
    </script>
</body>
</html>

